<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="./css/font.css">
    <link rel="stylesheet" href="./css/xadmin.css">
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <script src="./lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="./js/xadmin.js"></script>

</head>
<body>
<div class="x-body">
    <form class="layui-form">
        <div class="layui-form-item">
            <label for="username" class="layui-form-label">
                <span class="x-red">*</span>用户名
            </label>
            <div class="layui-input-inline">
                <input type="text" id="username" name="username" required="" lay-verify="required"
                       autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label for="username" class="layui-form-label">
                <span class="x-red">*</span>密码
            </label>
            <div class="layui-input-inline">
                <input type="text" id="password" name="password" required="" lay-verify="required"
                       autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">类型</label>
            <div class="layui-input-inline">
                <select name="type" id="type" lay-verify="required">
                    <option value="普通用户">普通用户</option>
                    <option value="VIP">VIP用户</option>
                    <option value="管理员">管理员</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label for="pic" class="layui-form-label">
                <span class="x-red">*</span>头像
            </label>
            <div class="layui-input-inline">
                <button type="button" class="layui-btn" id="test1">
                    <i class="layui-icon">&#xe67c;</i>上传图片
                </button>
                <img id="headpic" src="" width="200" height="200" style="display: none"/>
                <input type="hidden" id="hidden_headpic"/>
            </div>

        </div>

        <div class="layui-form-item">
            <label for="L_repass" class="layui-form-label">
            </label>
            <button  class="layui-btn" lay-filter="add" lay-submit="">
                增加
            </button>
        </div>
    </form>
</div>
<script>
    var form;
    layui.use('form', function(){
        form = layui.form;
    })
    var id=getURLParm();
    //根据ID查询用户数据
    $(function () {
        $.ajax({
            url:"tuser.do",
            data:{id:id,oper:"getById"},
            dataType:"json",
            success:function (data) {
                var username=data.data.username;
                var password=data.data.password;
                var type=data.data.type;
                var pic=data.data.pic;
                $("#username").val(username);
                $("#password").val(password);
                //$("#type").val(type);
                $('#type').find("option[value="+type+"]").attr("selected",true);
                form.render('select') //再次渲染
                console.log("pic="+pic);
                $("#headpic").attr("src","download.do?filename="+pic);
                $("#headpic").show();
            }
        })
    })
    layui.use('upload', function(){
        var upload = layui.upload;

        //执行实例
        var uploadInst = upload.render({
            elem: '#test1' //绑定元素
            ,url: 'upload.do' //上传接口
            ,done: function(res){
                //上传完毕回调
                if(res.code == 0){
                    var filename=res.data.src;
                    layer.msg("上传成功"+filename);
                    $("#headpic").show();
                    $("#headpic").attr("src","download.do?filename="+filename)
                    $("#hidden_headpic").val(filename);
                }
                else{
                    layer.msg("上传失败")
                }
            }
            ,error: function(){
                //请求异常回调
            }
        });
    });
    layui.use(['form','layer'], function(){
        $ = layui.jquery;
        var form = layui.form
            ,layer = layui.layer;

        //自定义验证规则
        form.verify({
            username: function(value){
                if(value.length < 5){
                    return '用户名称至少得5个字符啊';
                }
            }
        });

        //监听提交
        form.on('submit(add)', function(data){
            console.log(data);
            var username=$("#username").val();
            var password=$("#password").val();
            var type=$("#type").val();
            var pic=$("#hidden_headpic").val();
            console.log("type="+type);
            //发异步，把数据提交给后端
            $.ajax({
                url:"tuser.do",
                data:{id:id,username:username,password:password,type:type,pic:pic,oper:"update"},
                dataType:"json",
                success:function (data) {
                    layer.alert("修改成功", {icon: 6},function () {
                        parent.window.location.reload();
                        // 获得frame索引
                        var index = parent.layer.getFrameIndex(window.name);
                        //关闭当前frame
                        parent.layer.close(index);
                    });
                }
            });

            return false;
        });


    });
    /**
     * 获取URL传参
     */
    function getURLParm() {
        var searchURL = window.location.search;
        searchURL = searchURL.substring(1, searchURL.length);
        var targetPageId = searchURL.split("&")[0].split("=")[1];
        return targetPageId;
    }
</script>
</body>
</html>